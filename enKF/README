============================================
This is the README file for the ensemble 
Kalman Filter for the SHYFEM model
============================================

    Copyright (c) 2017 by 

    Marco Bajo
    Oceanography, ISMAR-CNR
    Arsenale Tesa 104, Castello 2737/F
    30122 Venezia
    Italy

    Tel.   : +39-041-2407934
    Fax    : +39-041-2407940
    E-Mail : marco.bajo@ismar.cnr.it


    This code is distributed under the conditions of the
    GNU General Public License. 
    See <http://www.gnu.org/licenses/>.



Directory structure
===================

.		Main code and utilities
EvKF		Geir Evenseen's code used for the analysis and
		for generating perturbations.



Compiling the code
===================

- cd enKF
- make cleanall
- make enkf_analysis

In order to run the enKF.sh script you need a program named parallel 
and the library liblapack-dev. You should find them in your Linux 
distribution.

Installation with Debian from root:
apt-get update && apt-get install parallel liblapack-dev

Installation with Ubuntu:
sudo apt-get update && apt-get install parallel liblapack-dev


Run the code
===================

Run ./enKF.sh without arguments to see the help.
In order to run the program some files must be prepared:

----------
setting file
----------
This file must contain the following information in different lines:
- Name of the bas-file with the bas extension;
- Dimension of the model state (nkn nel nlv);
- A flag equal to 1 to create a new ensemble of initial states by perturbing
  one state specified in a restart file (specify one restart file in
  "rstlist.txt" and one file in "skellist.txt"). If it is set to 0 the program
  loads an ensemble of restart files. If you use 1 you must provide also a file 
  named "init_ens.info", described below;
- A flag equal to 1 to use an augmented state with the model error, 0 to use a
  normal state. If this option is 1 you must provide also a file named 
  "mod_err.info", described below.

----------
ens_list.txt
----------
This is a list of skel and rst files of the ensemble. Starting from member 0,
each row must contain the name of a skel and a rst files, separated by space.
The ensemble size is the number of rows of this file.

----------
antime_list.txt
----------
A list of the times, in string format, of the analysis steps. It is advisable to have analysis steps
at least of one hour. At least an observation must be present at each step.
String format has the same convention used in SHYFEM model (e.g., YYYY-MM-DD::HH:MM:SS)

----------
obs_list.txt
----------
A list of files containing in each line:
- an identification number of the file (e.g., 1,2,3);
- a flag of the type of observation;
- the name of the file.

Possible flag for the observations are:
- 0DLEV : sea level timeseries;
- 2DVEL : FEM-file with 2D surface current fields (e.g., HFR radar).

The structure of the observation files is described below.

----------
init_ens.info & mod_err.info
----------
init_ens.info must contain a row with:
  - nx ny fmult theta sigma

mod_err.info must contain a row with:
  - nx ny fmult theta rerror dt tau

  where:
  - nx,ny are the dimension of the grid of the pseudo random fields
  - fmult is the mult factor to create a supersample from the initial ensemble
  - theta is the rotation of the pseudo random fields (0 East, anticlockwise)
  - rerror is the error relative to each value of the model variables. Use a
    small one. At the moment just the water levels have errors.
  - dt is the time between two observation steps (assumes regular intervals)
  - tau is the e-folding time of the red noise in the model error

The values containted in the two files are indipendent. 
The first file is used to create white noise to make the initial ensemble. 
Only the sea level is perturbed.
The second file is used to make red noise to propagate the model error,
by using an augmented state. This is not working, the routine make_2Dpert
gives a segmentation fault.

----------
skel files
----------
These are the files to make the str files of the ensemble members during the
assimilation. If you made a previous ensemble you can use those str files to
create these. 
It's extremely important that you set the following strings in the skel files:

- Section title:
  NAMESIM

- Section para: 
  itanf = 'ITANF'
  itend = 'ITEND'
  itrst = 'ITANF'
  idtrst = -1

- Section name:
  restrt = 'RESTRT'

If you want to save the results during the analysis add:

- Section para:
  itout = 'ITANF'
  itext = 'ITANF'
  itcon = 'ITANF'

All the other parameters can be set as you like.

----------
Initial restart files
----------
They must have one record at the time of the first analysis step. The first
restart must be the control (unperturbed) run, the 0 ensemble member. 
In order to create a good initial ensemble you can run an ensemble of
simulations with different forcings and/or boundary conditions and save the
restart at the first analysis step. The ensemble must be centered
(mean~=control).

----------
Observation files
----------
1)
Sea level timeseries with time and value:
string-time1 value1
string-time2 value2 
...

For each timeseries file a info file is needed, with the same name added of an
extension '.info'. This file must contain in 1 row: x y std
x, y = Coordinate of the observation, in the same reference system of the bas file. 
std = standard deviation (estimated error) of the observation

2)
Fem file with a surface current field. Bad values should be flagged with a -999.
As for the sea level timeseries, an info file is needed, containing a value
for the standard deviation.


Parameters of the assimilation
===================
See the file mod_para.F90 to set some more assimilation parameters.


Utilities
===================

shyfem_ens.sh:
executes shyfem in parallel by using an ensemble of str files. Without data
assimilation, just normal runs. For example you can use this for the final 
forecast runs

merge_ens.sh:
merges ext or shy files pruduced during the analysis period
(i.e., anXXX_enYYY.ZZZ) in nrens files.
Timeseries are extracted in text files, with both the background and
the analysis values at the analysis times. shy files are merged keeping
the analysis fields at the analysis times.

split_ext.sh:
splits an ensemble of ext file with a common basename.

make_ens_wind:
makes an ens of perturbed fields from a 2D field. FEM file format. Works also
for HFR radar fem files.
