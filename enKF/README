Run ./enKF.sh without arguments to see the help.

In order to run the program, the following files are needed.

----------
setting file
----------
This file must contain the following information in different lines:
- Name of the bas-file with the bas extension;
- Dimension of the model state (nkn nel nlv);
- Number of ensemble members;
- A flag equal to 1 to create a new ensemble of initial states by perturbing
  one state specified in a restart file (specify one restart file in
  "rstlist.txt" and one file in "skellist.txt"). If it is set to 0 the program
  loads an ensemble of restart files. If you use 1 you must provide also a file 
  named "init_ens.info", described below;
- A flag equal to 1 to use an augmented state with the model error, 0 to use a
  normal state. If this option is 1 you must provide also a file named 
  "mod_err.info", described below.

----------
skel_list.txt
----------
This is a list of skeleton files to create the str file. The structure of the
skel files is described below.

----------
rst_list.txt
----------
This is a list of initial restart files (background state). They must contain
a record at the time of your first observation (first analysis step).

----------
obs_list.txt
----------
A list of files containing in each line:
- an identification number of the file (e.g., 1,2,3);
- a flag of the type of observation;
- the name of the file.

Possible flag for the observations are:
- 0DLEV : sea level timeseries;
- 2DVEL : FEM-file with 2D surface current fields (e.g., HFR radar).

The structure of the observation files is described below.

----------
obstime_list.txt
----------
A list of the times of the analysis steps. It is advisable to have analysis steps
at least of one hour.

----------
init_ens.info & mod_err.info
----------
init_ens.info must contain a row with:
  - nx ny fmult theta sigma
mod_err.info must contain a row with:
  - nx ny fmult theta sigma dt tau

  where:
  - nx,ny are the dimension of the grid of the pseudo random fields
  - fmult is the mult factor to create a supersample from the initial ensemble
  - theta is the rotation of the pseudo random fields (0 East, anticlockwise)
  - sigma is the standard deviation of the fields (level. Change the code to
    set different)
  - dt is the time between two observation steps (assumes regular intervals)
  - tau is the e-folding time of the model error

The values containted in the two files are indipendent. The first file is used
to create the initial ensemble, the second to propagate the model error by
using an augmented state.

----------
skel files
----------
It is advisable to make the skel files using the str files used to produce the initial
background restart files. skel files must have these lines:
- in the "title" section put:
  Whatever title of sim
  NAMESIM
  BASIN
- in the "para" section put: 
  itrst = ITRST
  idtrst = IDTRST
  itanf = ITANF
  itend = ITEND
  nomp = NOMP 
- in the "name" section put:
  restrt = RESTRT

----------
Initial restart files
----------
They must contain just one state, saved at the time of the first observation. The
first restart file specified in the list is considered the control forecast, the
0 ensemble member. The list of restart files must be sorted as that of the skel files 
A possible way to make them is to run initial simulations ending at the first observation
time, varying the most uncertain forcings. Then save the final states in restart files
and list them.

----------
OBSERVATION FILES
----------
1)
Sea level timeseries with time and value:
time1 value1
time2 value2 
...

For each timeseries file a info file is needed, with the same name added of an
extension '.info'. This file must contain in 1 row: x y std
x, y = Coordinate of the observation, in the same reference system of the bas file. 
std = standard deviation (estimated error) of the observation

2)
Fem file with a surface current field. Flag values allowed with a -999.
Like for the sea level timeseries an info file is needed, containing just the
standard deviation.


-----------
Utilities
-----------
make_ens_wind:
makes an ens of perturbed fields from a 2D field. FEM file format

merge_ens_output.sh:
extracts the ets or ext files, produced during the assimilation run, and merges 
them, creating one file for each ens member and each variable. The shy files 
are merged but, since they have two records at the same time in the analysis 
steps, they cannot be plotted with the current shyplot version.

randomize_var.sh:
creates n skel files from one, with a random value of a parameter. The right
and left limits for the values must be specified. Don't use it use better
methods.


-----------
Compilation notes
-----------
Compile the code with:

- cd enKF
- make cleanall
- make enkf_analysis

In order to run the enKF.sh script you need a small GNU program, named "parallel" and liblapack-dev.

Installation with Debian from root:
apt-get update && apt-get install parallel liblapack-dev

Installation with Ubuntu:
sudo apt-get update && apt-get install parallel liblapack-dev


